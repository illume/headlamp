name: s390x ppc64le build and test

on:
  pull_request:
    paths:
      - 'backend/**'
      - Dockerfile
      - Makefile
      - '.github/workflows/build-other-arch.yml'
  push:
    branches:
      - main
      - rc-*
      - testing-rc-*

permissions:
  contents: read

jobs:
  backend-s390x:
    runs-on: ubuntu-latest
    name: backend build and test for s390x
    steps:
    - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
    - name: Set up QEMU
      uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf # v3.2.0
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@988b5a0280414f521da01fcc63a27aeeb4b104db # v3.6.1
    - name: Build and test backend for s390x
      run: |
        docker run --rm --platform linux/s390x \
          -v "${{ github.workspace }}/backend":/backend \
          -w /backend \
          golang:1.24.13@sha256:c29cdf32d47053ab0d914852d9c2ed2da12b3cf13079aaef1704ef21335e68a3 \
          sh -c "go build ./... && go test ./..."
    - name: Build s390x container image
      uses: docker/build-push-action@0a97817b6ade9f46837855d676c4cca3a2471fc9 # v4.2.1
      with:
        context: .
        push: false
        load: true
        platforms: linux/s390x
        tags: headlamp:s390x-test
        cache-from: type=gha
        cache-to: type=gha,mode=max
    - name: Verify s390x container image
      run: |
        output=$(docker run --rm --platform linux/s390x headlamp:s390x-test --version)
        echo "Version output: $output"
        echo "$output" | grep -q "linux/s390x" || (echo "ERROR: expected 'linux/s390x' in version output" && exit 1)
  backend-ppc64le:
    runs-on: ubuntu-latest
    name: backend build and test for ppc64le
    steps:
    - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
    - name: Set up QEMU
      uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf # v3.2.0
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@988b5a0280414f521da01fcc63a27aeeb4b104db # v3.6.1
    - name: Build and test backend for ppc64le
      run: |
        docker run --rm --platform linux/ppc64le \
          -v "${{ github.workspace }}/backend":/backend \
          -w /backend \
          golang:1.24.13@sha256:c29cdf32d47053ab0d914852d9c2ed2da12b3cf13079aaef1704ef21335e68a3 \
          sh -c "go build ./... && go test ./..."
    - name: Build ppc64le container image
      uses: docker/build-push-action@0a97817b6ade9f46837855d676c4cca3a2471fc9 # v4.2.1
      with:
        context: .
        push: false
        load: true
        platforms: linux/ppc64le
        tags: headlamp:ppc64le-test
        cache-from: type=gha
        cache-to: type=gha,mode=max
    - name: Verify ppc64le container image
      run: |
        output=$(docker run --rm --platform linux/ppc64le headlamp:ppc64le-test --version)
        echo "Version output: $output"
        echo "$output" | grep -q "linux/ppc64le" || (echo "ERROR: expected 'linux/ppc64le' in version output" && exit 1)
