name: Build App

on:
  pull_request:
    paths:
    - 'frontend/**'
    - 'Makefile'
    - '.github/**'
    - 'app/**'
    - 'backend/**'
  push:
    branches:
      - main
      - rc-*
      - testing-rc-*
    paths:
    - 'frontend/**'
    - Makefile
    - '.github/**'
    - 'app/**'
    - 'backend/**'

permissions:
  contents: read

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        node-version: [20.x]
    steps:
    - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
      with:
        node-version: ${{ matrix.node-version }}
    - uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4d7d973ad74ed # v5.1.0
      with:
        go-version: '1.24.*'
    - name: Run tests
      run: make app-test
    - name: Run tsc type checker
      run: make app-tsc
    - name: App linux
      run: |
        make app-linux
    - name: Verify Linux binaries exist
      run: |
        echo "Checking for built artifacts..."
        ls -lh app/dist/
        # Verify at least one AppImage or tar.gz was created
        if ls app/dist/*.AppImage 1> /dev/null 2>&1 || ls app/dist/*.tar.gz 1> /dev/null 2>&1; then
          echo "✓ Linux artifacts found"
        else
          echo "✗ No Linux artifacts found"
          exit 1
        fi
    - name: Extract and verify backend binary
      run: |
        # Extract tar.gz if it exists (easier to test than AppImage)
        # Use x64 tar.gz for testing
        TARBALL=$(ls app/dist/*-linux-x64.tar.gz 2>/dev/null | head -n 1)
        if [ ! -z "$TARBALL" ]; then
          echo "Extracting tar.gz: $TARBALL"
          mkdir -p /tmp/headlamp-test
          tar -xzf "$TARBALL" -C /tmp/headlamp-test
          # Find the backend server binary
          BACKEND_PATH=$(find /tmp/headlamp-test -name "headlamp-server" -type f | head -n 1)
          if [ -z "$BACKEND_PATH" ]; then
            echo "✗ Backend server binary not found in package"
            exit 1
          fi
          echo "Found backend at: $BACKEND_PATH"
          # Test version command
          chmod +x "$BACKEND_PATH"
          if ! VERSION_OUTPUT=$("$BACKEND_PATH" --version 2>&1); then
            echo "✗ Failed to execute backend --version"
            exit 1
          fi
          echo "Backend version: $VERSION_OUTPUT"
          if echo "$VERSION_OUTPUT" | grep -q "Headlamp"; then
            echo "✓ Backend binary is working"
          else
            echo "✗ Backend version check failed"
            exit 1
          fi
        else
          echo "✗ No x64 tar.gz found for backend verification"
          exit 1
        fi
    - name: Verify Electron app can run
      run: |
        # Reuse the extracted files from the previous step
        if [ ! -d /tmp/headlamp-test ]; then
          echo "✗ Expected extracted directory /tmp/headlamp-test not found"
          exit 1
        fi
        echo "Testing Electron app using previously extracted files..."
        # Find the headlamp executable in the previously extracted directory
        HEADLAMP_EXEC=$(find /tmp/headlamp-test -name "headlamp" -type f -executable | head -n 1)
        if [ -z "$HEADLAMP_EXEC" ]; then
          echo "✗ Headlamp executable not found"
          exit 1
        fi
        echo "Found Headlamp at: $HEADLAMP_EXEC"
        # Run with list-plugins command (exits immediately, no GUI needed)
        chmod +x "$HEADLAMP_EXEC"
        timeout 30 "$HEADLAMP_EXEC" list-plugins > /tmp/plugins-output.txt 2>&1
        EXIT_CODE=$?
        if [ $EXIT_CODE -eq 0 ]; then
          echo "✓ App executed successfully"
          cat /tmp/plugins-output.txt
        elif [ $EXIT_CODE -eq 124 ]; then
          echo "✗ App timed out"
          cat /tmp/plugins-output.txt || true
          exit 1
        else
          echo "✗ App failed to run (exit code: $EXIT_CODE)"
          cat /tmp/plugins-output.txt || true
          exit 1
        fi
  build-windows:
    runs-on: windows-2025
    strategy:
      matrix:
        node-version: [20.x]
    steps:
    - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
      with:
        node-version: ${{ matrix.node-version }}
    - uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4d7d973ad74ed # v5.1.0
      with:
        go-version: '1.24.*'
    - name: Dependencies
      uses: crazy-max/ghaction-chocolatey@e80bd39bb49cae70b67ea53d52d00833a7255c21 # v1.7.0
      with:
        args: install make
    - name: Run tests
      run: make app-test
    - name: Run tsc type checker
      run: make app-tsc
    - name: App Windows
      run: make app-win
    - name: Verify Windows binaries exist
      shell: pwsh
      run: |
        Write-Host "Checking for built artifacts..."
        Get-ChildItem app/dist/ | Format-Table
        # Verify NSIS installer was created
        $installers = Get-ChildItem app/dist/*.exe -ErrorAction SilentlyContinue
        if ($installers) {
          Write-Host "✓ Windows installer found"
        } else {
          Write-Host "✗ No Windows installer found"
          exit 1
        }
    - name: Verify backend binary in unpacked resources
      shell: pwsh
      run: |
        # Check if there's an unpacked directory
        $unpackedDirs = Get-ChildItem app/dist/win-unpacked -ErrorAction SilentlyContinue
        if ($unpackedDirs) {
          Write-Host "Found unpacked build directory"
          $backendPath = Get-ChildItem app/dist/win-unpacked/resources/headlamp-server.exe -ErrorAction SilentlyContinue
          if ($backendPath) {
            Write-Host "Found backend at: $($backendPath.FullName)"
            # Test version command
            $versionOutput = & $backendPath.FullName --version 2>&1
            $exitCode = $LASTEXITCODE
            if ($exitCode -ne 0) {
              Write-Host "✗ Backend version command failed with exit code $exitCode"
              exit $exitCode
            }
            Write-Host "Backend version: $versionOutput"
            if ($versionOutput -match "Headlamp") {
              Write-Host "✓ Backend binary is working"
            } else {
              Write-Host "✗ Backend version check failed"
              exit 1
            }
          } else {
            Write-Host "✗ Backend server binary not found in unpacked resources"
            exit 1
          }
        } else {
          Write-Host "Unpacked directory not found, checking in build output..."
          # Alternative: look in the dist folder structure
          $backendPath = Get-ChildItem -Path app/dist -Recurse -Filter "headlamp-server.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($backendPath) {
            Write-Host "Found backend at: $($backendPath.FullName)"
            $versionOutput = & $backendPath.FullName --version 2>&1
            $exitCode = $LASTEXITCODE
            if ($exitCode -ne 0) {
              Write-Host "✗ Backend version command failed with exit code $exitCode"
              exit $exitCode
            }
            Write-Host "Backend version: $versionOutput"
            if ($versionOutput -match "Headlamp") {
              Write-Host "✓ Backend binary is working"
            } else {
              Write-Host "✗ Backend version check failed"
              exit 1
            }
          } else {
            Write-Host "✗ Could not find backend binary to test in dist output"
            exit 1
          }
        }
    - name: Verify Electron app can run
      shell: pwsh
      run: |
        # Try to run the app with list-plugins command
        $appPath = Get-ChildItem app/dist/win-unpacked/Headlamp.exe -ErrorAction SilentlyContinue
        if ($appPath) {
          Write-Host "Testing Electron app..."
          Write-Host "Found Headlamp at: $($appPath.FullName)"
          # Run with list-plugins command (exits immediately, no GUI needed)
          try {
            # Create temp directory if it doesn't exist
            $tempDir = "$env:TEMP\headlamp-test"
            if (-not (Test-Path $tempDir)) {
              New-Item -ItemType Directory -Path $tempDir -Force | Out-Null
            }
            $outputFile = Join-Path $tempDir "plugins-output.txt"
            $errorFile = Join-Path $tempDir "plugins-error.txt"
            
            $process = Start-Process -FilePath $appPath.FullName -ArgumentList "list-plugins" -Wait -PassThru -NoNewWindow -RedirectStandardOutput $outputFile -RedirectStandardError $errorFile
            if ($process.ExitCode -eq 0) {
              Write-Host "✓ App executed successfully"
              if (Test-Path $outputFile) {
                Get-Content $outputFile
              }
            } else {
              Write-Host "✗ App failed to run (exit code: $($process.ExitCode))"
              if (Test-Path $errorFile) {
                Get-Content $errorFile
              }
              exit 1
            }
          } catch {
            Write-Host "✗ Error running app: $_"
            exit 1
          }
        } else {
          Write-Host "✗ Unpacked app not found, failing app verification"
          exit 1
        }
  build-mac:
    runs-on: macos-latest
    strategy:
      matrix:
        node-version: [20.x]
    steps:
    - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
      with:
        node-version: ${{ matrix.node-version }}
    - uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4d7d973ad74ed # v5.1.0
      with:
        go-version: '1.24.*'
    - name: Dependencies
      run: brew install make
    - name: Run tests
      run: make app-test
    - name: Run tsc type checker
      run: make app-tsc
    - name: App Mac
      run: |
        make app-mac
    - name: Verify Mac binaries exist
      run: |
        echo "Checking for built artifacts..."
        ls -lh app/dist/
        # Verify DMG was created
        if ls app/dist/*.dmg 1> /dev/null 2>&1; then
          echo "✓ Mac DMG found"
        else
          echo "✗ No Mac DMG found"
          exit 1
        fi
    - name: Verify app bundle and backend binary
      run: |
        # Check if there's a mac directory with the app bundle
        if [ -d "app/dist/mac" ]; then
          echo "Found mac build directory"
          # Find the .app bundle
          APP_BUNDLE=$(find app/dist/mac -name "*.app" -type d | head -n 1)
          if [ -z "$APP_BUNDLE" ]; then
            echo "✗ App bundle not found"
            exit 1
          fi
          echo "Found app bundle at: $APP_BUNDLE"
          # Find the backend server in Resources
          BACKEND_PATH="$APP_BUNDLE/Contents/Resources/headlamp-server"
          if [ -f "$BACKEND_PATH" ]; then
            echo "Found backend at: $BACKEND_PATH"
            # Test version command
            chmod +x "$BACKEND_PATH"
            if ! VERSION_OUTPUT=$("$BACKEND_PATH" --version 2>&1); then
              echo "✗ Failed to execute backend --version"
              exit 1
            fi
            echo "Backend version: $VERSION_OUTPUT"
            if echo "$VERSION_OUTPUT" | grep -q "Headlamp"; then
              echo "✓ Backend binary is working"
            else
              echo "✗ Backend version check failed"
              exit 1
            fi
          else
            echo "✗ Backend server binary not found at $BACKEND_PATH"
            exit 1
          fi
          
          # Now test the Electron app
          echo "Testing Electron app..."
          HEADLAMP_EXEC="$APP_BUNDLE/Contents/MacOS/Headlamp"
          if [ -f "$HEADLAMP_EXEC" ]; then
            echo "Found Headlamp at: $HEADLAMP_EXEC"
            chmod +x "$HEADLAMP_EXEC"
            # Run with list-plugins command to verify app can start
            # Note: On macOS CI without display, the app may not exit cleanly even with list-plugins
            # Use perl-based timeout as timeout command is not available on macOS by default
            echo "Running app with 10 second timeout..."
            set +e  # Temporarily disable exit on error
            perl -e 'alarm shift; exec @ARGV' 10 "$HEADLAMP_EXEC" list-plugins > /tmp/plugins-output.txt 2>&1
            EXIT_CODE=$?
            set -e  # Re-enable exit on error
            echo "App exited with code: $EXIT_CODE"
            echo "Output from app:"
            cat /tmp/plugins-output.txt || echo "(no output)"
            
            if [ $EXIT_CODE -eq 0 ]; then
              echo "✓ App executed successfully"
            elif [ $EXIT_CODE -eq 142 ]; then
              # Timeout occurred - app started but didn't exit cleanly (expected on macOS CI without display)
              echo "⚠ App timed out after 10 seconds (expected behavior on macOS CI without display)"
              echo "✓ App verification completed - timeout indicates app started successfully"
            else
              echo "✗ App failed to run (exit code: $EXIT_CODE)"
              exit 1
            fi
          else
            echo "✗ Headlamp executable not found at $HEADLAMP_EXEC"
            exit 1
          fi
        else
          echo "Mac build directory not found, checking DMG contents..."
          # Mount the DMG and test both backend and app
          DMG_FILE=$(ls app/dist/*.dmg | head -n 1)
          if [ ! -z "$DMG_FILE" ]; then
            echo "Mounting DMG: $DMG_FILE"
            # Capture the full mount point path (last field after tab delimiter)
            MOUNT_POINT=$(hdiutil attach "$DMG_FILE" 2>&1 | grep Volumes | tail -1 | awk -F'\t' '{print $NF}')
            if [ -z "$MOUNT_POINT" ]; then
              echo "✗ Failed to mount DMG or parse mount point"
              exit 1
            fi
            echo "DMG mounted at: $MOUNT_POINT"
            APP_BUNDLE=$(find "$MOUNT_POINT" -name "*.app" -type d | head -n 1)
            if [ ! -z "$APP_BUNDLE" ]; then
              echo "Found app in DMG: $APP_BUNDLE"
              
              # Test backend binary
              BACKEND_PATH="$APP_BUNDLE/Contents/Resources/headlamp-server"
              if [ -f "$BACKEND_PATH" ]; then
                chmod +x "$BACKEND_PATH"
                if ! VERSION_OUTPUT=$("$BACKEND_PATH" --version 2>&1); then
                  echo "✗ Backend --version command failed"
                  hdiutil detach "$MOUNT_POINT" > /dev/null 2>&1
                  exit 1
                fi
                echo "Backend version: $VERSION_OUTPUT"
                if echo "$VERSION_OUTPUT" | grep -q "Headlamp"; then
                  echo "✓ Backend binary is working"
                else
                  echo "✗ Backend version check failed"
                  hdiutil detach "$MOUNT_POINT" > /dev/null 2>&1
                  exit 1
                fi
              else
                echo "✗ Backend server binary not found at $BACKEND_PATH"
                hdiutil detach "$MOUNT_POINT" > /dev/null 2>&1
                exit 1
              fi
              
              # Test Electron app
              echo "Testing Electron app from DMG..."
              HEADLAMP_EXEC="$APP_BUNDLE/Contents/MacOS/Headlamp"
              if [ -f "$HEADLAMP_EXEC" ]; then
                chmod +x "$HEADLAMP_EXEC"
                # Run with list-plugins command to verify app can start
                # Note: On macOS CI without display, the app may not exit cleanly even with list-plugins
                # Use perl-based timeout as timeout command is not available on macOS by default
                echo "Running app with 10 second timeout..."
                set +e  # Temporarily disable exit on error
                perl -e 'alarm shift; exec @ARGV' 10 "$HEADLAMP_EXEC" list-plugins > /tmp/plugins-output.txt 2>&1
                EXIT_CODE=$?
                set -e  # Re-enable exit on error
                echo "App exited with code: $EXIT_CODE"
                echo "Output from app:"
                cat /tmp/plugins-output.txt || echo "(no output)"
                
                if [ $EXIT_CODE -eq 0 ]; then
                  echo "✓ App executed successfully"
                  hdiutil detach "$MOUNT_POINT" > /dev/null 2>&1
                elif [ $EXIT_CODE -eq 142 ]; then
                  # Timeout occurred - app started but didn't exit cleanly (expected on macOS CI without display)
                  echo "⚠ App timed out after 10 seconds (expected behavior on macOS CI without display)"
                  echo "✓ App verification completed - timeout indicates app started successfully"
                  hdiutil detach "$MOUNT_POINT" > /dev/null 2>&1
                else
                  echo "✗ App failed to run (exit code: $EXIT_CODE)"
                  hdiutil detach "$MOUNT_POINT" > /dev/null 2>&1
                  exit 1
                fi
              else
                echo "✗ Headlamp executable not found in DMG app bundle"
                hdiutil detach "$MOUNT_POINT" > /dev/null 2>&1
                exit 1
              fi
            else
              echo "✗ App bundle not found in DMG"
              hdiutil detach "$MOUNT_POINT" > /dev/null 2>&1
              exit 1
            fi
          else
            echo "✗ No DMG file found"
            exit 1
          fi
        fi
